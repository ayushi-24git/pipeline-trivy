apiVersion: tekton.dev/v1beta1

kind: Task

metadata:
  name: scan-image

spec:
  description: This task is for image scanning.

  workspaces:
    - name: source
      description: Workspace for fetched image.

  params:
    - name: image-scan
      type: string
      description: image to be scanned.
      default: ""

  steps:
    - name: scan-image-step
      image: aquasec/trivy:0.16.0
      workingDir: $(workspaces.source.path)
      script:  |
        
        set -e
               
        echo -e "Trivy Security Scan image in registry"
        trivy image --exit-code 0 --input ${params.image-scan}
        trivy image --exit-code 1 --severity CRITICAL --input ${params.image-scan}
        my_exit_code=$?
        echo "Scan exit code :--- $my_exit_code"
        if [ ${my_exit_code} == 1 ]; then
            echo "Trivy scanning completed. CRITICAL Vulnerabilities found."
            exit 1
        else
          echo "Trivy scanning completed. CRITICAL vulnerabilities not found."
        
      



  
    
